# YFYæ¨¡å—æµ‹è¯•æ„å»ºæ–‡ä»¶
# ä½¿ç”¨ just å‘½ä»¤è¿è¡Œå„ç§æµ‹è¯•å’Œæ„å»ºä»»åŠ¡

# è®¾ç½®shellï¼ˆWindowså…¼å®¹ï¼‰
set shell := ["powershell.exe", "-c"]

# è®¾ç½®å˜é‡
CC := "gcc"
CFLAGS := "-I../../../utilities -I.."
SOURCES := "../yfy_data.c ../yfy_interface.c"
BUILD_DIR := "build"

# é»˜è®¤ä»»åŠ¡ï¼šæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
default:
    @echo "YFYæ¨¡å—æµ‹è¯•æ„å»ºç³»ç»Ÿ"
    @echo "===================="
    @echo ""
    @echo "å¯ç”¨å‘½ä»¤ï¼š"
    @echo "  just build          - ç¼–è¯‘æ‰€æœ‰æµ‹è¯•"
    @echo "  just test           - è¿è¡Œä¸»è¦æµ‹è¯•å¥—ä»¶"
    @echo "  just test-quick     - è¿è¡Œå¿«é€Ÿå†’çƒŸæµ‹è¯•"
    @echo "  just test-full      - è¿è¡Œå®Œæ•´è¯¦ç»†æµ‹è¯•"
    @echo "  just test-perf      - è¿è¡Œæ€§èƒ½æµ‹è¯•"
    @echo "  just test-macro     - è¿è¡Œå®æµ‹è¯•"
    @echo "  just test-interval  - è¿è¡Œé—´éš”æ£€æŸ¥æµ‹è¯•"
    @echo "  just test-all       - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
    @echo "  just clean          - æ¸…ç†æ„å»ºæ–‡ä»¶"
    @echo "  just help           - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
help: default

# åˆ›å»ºæ„å»ºç›®å½•
_create-build-dir:
    @if (!(Test-Path "{{BUILD_DIR}}")) { New-Item -ItemType Directory -Path "{{BUILD_DIR}}" }

# ç¼–è¯‘ä¸»è¦æµ‹è¯•å¥—ä»¶
build-main: _create-build-dir
    {{CC}} {{CFLAGS}} {{SOURCES}} run_tests.c -o {{BUILD_DIR}}/run_tests.exe

# ç¼–è¯‘è¯¦ç»†å•å…ƒæµ‹è¯•
build-unit: _create-build-dir
    {{CC}} {{CFLAGS}} {{SOURCES}} unit_test.c -o {{BUILD_DIR}}/unit_test.exe

# ç¼–è¯‘ç»¼åˆæ€§èƒ½æµ‹è¯•
build-comprehensive: _create-build-dir
    {{CC}} {{CFLAGS}} {{SOURCES}} comprehensive_test.c -o {{BUILD_DIR}}/comprehensive_test.exe

# ç¼–è¯‘å®æµ‹è¯•
build-macro: _create-build-dir
    {{CC}} {{CFLAGS}} test_macro_only.c -o {{BUILD_DIR}}/test_macro.exe

# ç¼–è¯‘å®ç¤ºä¾‹
build-macro-example: _create-build-dir
    {{CC}} {{CFLAGS}} macro_usage_example.c -o {{BUILD_DIR}}/macro_example.exe

# ç¼–è¯‘å¤´æ–‡ä»¶å®Œæ•´æ€§æµ‹è¯•
build-header: _create-build-dir
    {{CC}} {{CFLAGS}} {{SOURCES}} test_header_completeness.c -o {{BUILD_DIR}}/test_header.exe

# ç¼–è¯‘é—´éš”æ£€æŸ¥æµ‹è¯•
build-interval: _create-build-dir
    {{CC}} {{CFLAGS}} {{SOURCES}} test_interval_check.c -o {{BUILD_DIR}}/test_interval.exe

# ç¼–è¯‘æ‰€æœ‰æµ‹è¯•
build: build-main build-unit build-comprehensive build-macro build-macro-example build-header build-interval
    @echo "âœ… æ‰€æœ‰æµ‹è¯•ç¨‹åºç¼–è¯‘å®Œæˆ"

# è¿è¡Œä¸»è¦æµ‹è¯•å¥—ä»¶ï¼ˆæ¨èï¼‰
test: build-main
    @echo "ğŸš€ è¿è¡Œä¸»è¦æµ‹è¯•å¥—ä»¶..."
    @./{{BUILD_DIR}}/run_tests.exe

# è¿è¡Œå¿«é€Ÿå†’çƒŸæµ‹è¯•
test-quick: build-main
    @echo "âš¡ è¿è¡Œå¿«é€Ÿå†’çƒŸæµ‹è¯•..."
    @./{{BUILD_DIR}}/run_tests.exe quick

# è¿è¡Œè¯¦ç»†å•å…ƒæµ‹è¯•
test-full: build-unit
    @echo "ğŸ” è¿è¡Œè¯¦ç»†å•å…ƒæµ‹è¯•..."
    @./{{BUILD_DIR}}/unit_test.exe

# è¿è¡Œæ€§èƒ½æµ‹è¯•
test-perf: build-comprehensive
    @echo "ğŸ“Š è¿è¡Œæ€§èƒ½æµ‹è¯•..."
    @./{{BUILD_DIR}}/comprehensive_test.exe

# è¿è¡Œå®æµ‹è¯•
test-macro: build-macro
    @echo "ğŸ”§ è¿è¡Œ32ä½å®æµ‹è¯•..."
    @./{{BUILD_DIR}}/test_macro.exe

# è¿è¡Œå®ç¤ºä¾‹
demo-macro: build-macro-example
    @echo "ğŸ“– è¿è¡Œå®ä½¿ç”¨ç¤ºä¾‹..."
    @./{{BUILD_DIR}}/macro_example.exe

# è¿è¡Œå¤´æ–‡ä»¶å®Œæ•´æ€§æµ‹è¯•
test-header: build-header
    @echo "ğŸ“‹ è¿è¡Œå¤´æ–‡ä»¶å®Œæ•´æ€§æµ‹è¯•..."
    @./{{BUILD_DIR}}/test_header.exe

# è¿è¡Œé—´éš”æ£€æŸ¥æµ‹è¯•
test-interval: build-interval
    @echo "â±ï¸ è¿è¡Œ1000msé—´éš”æ£€æŸ¥æµ‹è¯•..."
    @./{{BUILD_DIR}}/test_interval.exe

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
test-all: test test-full test-perf test-macro test-header test-interval
    @echo ""
    @echo "ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼"

# æ¸…ç†æ„å»ºæ–‡ä»¶
clean:
    @echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶..."
    @if (Test-Path "{{BUILD_DIR}}") { Remove-Item -Recurse -Force "{{BUILD_DIR}}" }
    @Remove-Item -Force "*.exe", "*.o" -ErrorAction SilentlyContinue
    @echo "âœ… æ¸…ç†å®Œæˆ"

# é‡æ–°æ„å»ºæ‰€æœ‰
rebuild: clean build
    @echo "ğŸ”„ é‡æ–°æ„å»ºå®Œæˆ"

# æŒç»­é›†æˆæµ‹è¯•ï¼ˆå¿«é€ŸéªŒè¯ï¼‰
ci: test-quick
    @echo "âœ… CIæµ‹è¯•é€šè¿‡"

# å‘å¸ƒå‰æµ‹è¯•ï¼ˆå®Œæ•´éªŒè¯ï¼‰
release-test: test-all
    @echo "ğŸš€ å‘å¸ƒå‰æµ‹è¯•å®Œæˆ"

# å¼€å‘è€…å¿«é€ŸéªŒè¯
dev: test-quick
    @echo "ğŸ‘¨â€ğŸ’» å¼€å‘è€…å¿«é€ŸéªŒè¯å®Œæˆ"

# æ€§èƒ½åŸºå‡†æµ‹è¯•
benchmark: test-perf
    @echo "ğŸ“ˆ æ€§èƒ½åŸºå‡†æµ‹è¯•å®Œæˆ"

# è°ƒè¯•æ¨¡å¼ç¼–è¯‘ï¼ˆæ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼‰
build-debug: _create-build-dir
    {{CC}} {{CFLAGS}} -g -DDEBUG {{SOURCES}} run_tests.c -o {{BUILD_DIR}}/run_tests_debug.exe
    @echo "ğŸ› è°ƒè¯•ç‰ˆæœ¬ç¼–è¯‘å®Œæˆ"

# è¿è¡Œè°ƒè¯•ç‰ˆæœ¬æµ‹è¯•
test-debug: build-debug
    @echo "ğŸ› è¿è¡Œè°ƒè¯•ç‰ˆæœ¬æµ‹è¯•..."
    @./{{BUILD_DIR}}/run_tests_debug.exe

# ä¼˜åŒ–ç‰ˆæœ¬ç¼–è¯‘
build-release: _create-build-dir
    {{CC}} {{CFLAGS}} -O2 -DNDEBUG {{SOURCES}} run_tests.c -o {{BUILD_DIR}}/run_tests_release.exe
    @echo "ğŸš€ ä¼˜åŒ–ç‰ˆæœ¬ç¼–è¯‘å®Œæˆ"

# è¿è¡Œä¼˜åŒ–ç‰ˆæœ¬æµ‹è¯•
test-release: build-release
    @echo "ğŸš€ è¿è¡Œä¼˜åŒ–ç‰ˆæœ¬æµ‹è¯•..."
    @./{{BUILD_DIR}}/run_tests_release.exe

# æ˜¾ç¤ºæ„å»ºä¿¡æ¯
info:
    @echo "æ„å»ºä¿¡æ¯ï¼š"
    @echo "ç¼–è¯‘å™¨: {{CC}}"
    @echo "ç¼–è¯‘é€‰é¡¹: {{CFLAGS}}"
    @echo "æºæ–‡ä»¶: {{SOURCES}}"
    @echo "æ„å»ºç›®å½•: {{BUILD_DIR}}"
    @echo "å½“å‰ç›®å½•: $(pwd)"

# æ£€æŸ¥å·¥å…·æ˜¯å¦å¯ç”¨
check-tools:
    @echo "ğŸ”§ æ£€æŸ¥å·¥å…·å¯ç”¨æ€§..."
    @try { gcc --version; echo "âœ… gcc å¯ç”¨" } catch { echo "âŒ gcc æœªå®‰è£…" }
    @echo "âœ… å·¥å…·æ£€æŸ¥å®Œæˆ"